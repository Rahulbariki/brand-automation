<!DOCTYPE html>
<html lang="en" data-theme="cosmic">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative World ‚Äî BrandNova</title>
    <link rel="stylesheet" href="css/universe.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/auth.js"></script>
    <style>
        .auth-skeleton {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            background: #0f172a;
            display: flex;
            color: white;
            font-family: sans-serif;
            transition: opacity 0.5s;
        }

        .skeleton-sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.02);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .skeleton-item {
            height: 48px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 8px;
            animation: pulse 1.5s infinite ease-in-out;
        }

        .skeleton-main {
            flex: 1;
            padding: 3rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .skeleton-header {
            height: 60px;
            width: 40%;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 8px;
            animation: pulse 1.5s infinite ease-in-out;
        }

        .skeleton-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .skeleton-card {
            height: 120px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes slideInSidebar {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes fadeInMain {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .kpi-animate {
            animation: scaleIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        .sidebar-animate {
            animation: slideInSidebar 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        .main-animate {
            animation: fadeInMain 0.7s ease both;
        }
    </style>
    <script>
        // We will run checkSession after the page starts loading
        // to allow Supabase to catch the URL hash
    </script>
</head>

<body>

    <!-- ‚ïê‚ïê‚ïê Background Layers ‚ïê‚ïê‚ïê -->
    <canvas id="universe-particles"></canvas>
    <div class="universe-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="universe-grain"></div>
    <div class="cursor-glow"></div>

    <!-- ‚ïê‚ïê‚ïê Sidebar ‚ïê‚ïê‚ïê -->
    <aside class="universe-sidebar" id="sidebar">
        <div class="sidebar-logo">
            <span class="sidebar-logo-icon">‚ú¶</span>
            <span class="sidebar-logo-text">BrandNova</span>
        </div>

        <nav class="sidebar-nav">
            <a href="#" class="sidebar-link active" data-view="home">
                <i class="fas fa-planet-ringed fa-fw"></i>
                <i class="fas fa-home fa-fw"></i> Creative World
            </a>
            <a href="#" class="sidebar-link" data-view="names">
                <i class="fas fa-lightbulb fa-fw"></i> Brand Names
            </a>
            <a href="#" class="sidebar-link" data-view="logo">
                <i class="fas fa-paint-brush fa-fw"></i> Logo Studio
            </a>
            <a href="#" class="sidebar-link" data-view="marketing">
                <i class="fas fa-pen-fancy fa-fw"></i> Marketing
            </a>
            <a href="#" class="sidebar-link" data-view="pitch">
                <i class="fas fa-rocket fa-fw"></i> Startup Tools
            </a>
            <a href="#" class="sidebar-link" data-view="sentiment">
                <i class="fas fa-heart fa-fw"></i> Sentiment
            </a>
            <a href="#" class="sidebar-link" data-view="chat">
                <i class="fas fa-robot fa-fw"></i> AI Consultant
            </a>
            <a href="#" class="sidebar-link" data-view="admin" id="adminLink" style="display:none;">
                <i class="fas fa-shield-halved fa-fw"></i> Admin Panel
            </a>

            <div style="margin-top:auto;padding-top:1rem;border-top:1px solid var(--border);">
                <div class="sidebar-link"
                    style="flex-direction:column;align-items:flex-start;gap:.4rem;padding:.8rem 1rem;">
                    <div
                        style="font-size:.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;">
                        Usage Today</div>
                    <div style="font-size:.9rem;font-weight:700;" id="usageText">0 / 5</div>
                    <div class="usage-bar-wrap" style="width:100%;">
                        <div class="usage-bar-fill" id="usageBar" style="width:0%;"></div>
                    </div>
                </div>
            </div>

            <div class="theme-toggle-wrap" style="padding:.5rem 1rem;">
                <button class="theme-toggle-btn"
                    style="width:100%;border-radius:var(--radius-sm);height:auto;padding:.6rem;">
                    <i class="fas fa-palette"></i>&nbsp; Theme
                </button>
                <div class="theme-menu" style="bottom:calc(100% + 10px);top:auto;left:0;right:auto;"></div>
            </div>

            <a href="#" class="sidebar-link danger" id="logoutBtn">
                <i class="fas fa-sign-out-alt fa-fw"></i> Logout
            </a>
        </nav>
    </aside>

    <!-- ‚ïê‚ïê‚ïê Main Content ‚ïê‚ïê‚ïê -->
    <main class="universe-main" id="mainContent">

        <!-- ‚ïê‚ïê‚ïê VIEW: Home (Creative World) ‚ïê‚ïê‚ïê -->
        <div class="page-view" id="view-home">
            <div class="universe-header">
                <div>
                    <h1 class="page-title">Welcome to the <span class="grad">Universe</span></h1>
                    <p class="page-subtitle">Choose a module to begin creating.</p>
                </div>
            </div>

            <!-- Stat Cards -->
            <div class="stat-grid">
                <div class="glass-card stat-card">
                    <h4>Total Creations</h4>
                    <div class="stat-value" id="statTotal" data-count="0">0</div>
                    <div class="stat-trend up"><i class="fas fa-arrow-up"></i> Session active</div>
                </div>
                <div class="glass-card stat-card">
                    <h4>AI Speed</h4>
                    <div class="stat-value">~45ms</div>
                    <div class="stat-trend"><i class="fas fa-bolt"></i> Groq LLaMA</div>
                </div>
                <div class="glass-card stat-card">
                    <h4>Plan</h4>
                    <div class="stat-value" id="statPlan">Free</div>
                    <div class="stat-trend"><i class="fas fa-gem"></i> <a href="#" onclick="showUpgradeModal()"
                            style="color:var(--accent);">Upgrade</a></div>
                </div>
            </div>

            <!-- Floating Module Cards -->
            <div class="module-grid">
                <div class="glass-card module-card" data-view="names">
                    <div class="module-icon">üß†</div>
                    <h3>Brand Name Generator</h3>
                    <p>Generate unique, memorable brand names powered by LLaMA 70B AI.</p>
                    <span class="module-tag"><i class="fas fa-zap"></i> AI Powered</span>
                </div>
                <div class="glass-card module-card" data-view="logo">
                    <div class="module-icon">üé®</div>
                    <h3>Logo Studio</h3>
                    <p>Design stunning logos using Stable Diffusion XL. HD export included.</p>
                    <span class="module-tag pro"><i class="fas fa-crown"></i> Pro Feature</span>
                </div>
                <div class="glass-card module-card" data-view="marketing">
                    <div class="module-icon">‚úçÔ∏è</div>
                    <h3>Marketing Copy</h3>
                    <p>Generate ad copy, social captions, product descriptions, and more.</p>
                    <span class="module-tag"><i class="fas fa-zap"></i> AI Powered</span>
                </div>
                <div class="glass-card module-card" data-view="pitch">
                    <div class="module-icon">üöÄ</div>
                    <h3>Startup Tools</h3>
                    <p>Elevator pitches, investor emails, competitor analysis for founders.</p>
                    <span class="module-tag"><i class="fas fa-star"></i> New</span>
                </div>
                <div class="glass-card module-card" data-view="sentiment">
                    <div class="module-icon">üìä</div>
                    <h3>Sentiment Analysis</h3>
                    <p>Analyze customer reviews and align feedback with your brand tone.</p>
                    <span class="module-tag"><i class="fas fa-zap"></i> AI Powered</span>
                </div>
                <div class="glass-card module-card" data-view="chat">
                    <div class="module-icon">üí¨</div>
                    <h3>AI Brand Consultant</h3>
                    <p>Chat with IBM Granite for strategic branding and positioning advice.</p>
                    <span class="module-tag"><i class="fas fa-microchip"></i> IBM Granite</span>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê VIEW: Brand Names ‚ïê‚ïê‚ïê -->
        <div class="page-view" id="view-names" style="display:none;">
            <div class="universe-header">
                <div>
                    <h1 class="page-title"><span class="grad">Brand Name</span> Generator</h1>
                    <p class="page-subtitle">AI-powered brand naming with LLaMA 70B</p>
                </div>
                <button class="ghost-btn" onclick="showView('home')"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="glass-card" style="padding:2rem;max-width:700px;">
                <form id="nameForm">
                    <div class="float-input-group">
                        <input class="float-input" id="n_industry" placeholder="Industry (e.g. FinTech, HealthCare)"
                            required>
                    </div>
                    <div class="float-input-group">
                        <input class="float-input" id="n_keywords" placeholder="Keywords (comma-separated)" required>
                    </div>
                    <div class="float-input-group">
                        <input class="float-input" id="n_tone" placeholder="Tone (modern, playful, luxurious...)"
                            value="modern">
                    </div>
                    <button type="submit" class="glow-btn" style="width:100%;justify-content:center;padding:1rem;">
                        <i class="fas fa-sparkles"></i> Generate Names
                    </button>
                </form>
            </div>
            <!-- AI Loader (hidden) -->
            <div class="ai-loader" id="nameLoader" style="display:none;">
                <div class="ai-loader-ring"></div>
                <div class="ai-loader-dots"><span></span><span></span><span></span></div>
                <div class="ai-loader-text">AI is thinking...</div>
            </div>
            <!-- Results -->
            <div id="nameResults" style="margin-top:1.5rem;display:grid;gap:.8rem;"></div>
        </div>

        <!-- ‚ïê‚ïê‚ïê VIEW: Logo Studio ‚ïê‚ïê‚ïê -->
        <div class="page-view" id="view-logo" style="display:none;">
            <div class="universe-header">
                <div>
                    <h1 class="page-title"><span class="grad">Logo</span> Studio</h1>
                    <p class="page-subtitle">AI image generation with Stable Diffusion XL</p>
                </div>
                <button class="ghost-btn" onclick="showView('home')"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="glass-card" style="padding:2rem;max-width:700px;">
                <form id="logoForm">
                    <div class="float-input-group">
                        <input class="float-input" id="l_brand" placeholder="Brand Name" required>
                    </div>
                    <div class="float-input-group">
                        <input class="float-input" id="l_industry" placeholder="Industry" required>
                    </div>
                    <div class="float-input-group">
                        <input class="float-input" id="l_keywords" placeholder="Keywords (comma-separated)" required>
                    </div>
                    <div class="float-input-group">
                        <input class="float-input" id="l_style" placeholder="Style (minimalist, abstract, vintage)"
                            value="minimalist">
                    </div>
                    <button type="submit" class="glow-btn" style="width:100%;justify-content:center;padding:1rem;">
                        <i class="fas fa-wand-magic-sparkles"></i> Generate Logo
                    </button>
                </form>
            </div>
            <div class="ai-loader" id="logoLoader" style="display:none;">
                <div class="ai-loader-ring"></div>
                <div class="ai-loader-dots"><span></span><span></span><span></span></div>
                <div class="ai-loader-text">Creating your logo...</div>
            </div>
            <div id="logoResults" style="margin-top:1.5rem;text-align:center;"></div>
        </div>

        <!-- ‚ïê‚ïê‚ïê VIEW: Marketing ‚ïê‚ïê‚ïê -->
        <div class="page-view" id="view-marketing" style="display:none;">
            <div class="universe-header">
                <div>
                    <h1 class="page-title"><span class="grad">Marketing</span> Copy Engine</h1>
                    <p class="page-subtitle">Generate ads, captions, product copy instantly</p>
                </div>
                <button class="ghost-btn" onclick="showView('home')"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="glass-card" style="padding:2rem;max-width:700px;">
                <form id="marketingForm">
                    <div class="float-input-group">
                        <input class="float-input" id="m_brand" placeholder="Brand Name" required>
                    </div>
                    <div class="float-input-group">
                        <textarea class="float-input float-textarea" id="m_desc" placeholder="Brand Description"
                            required></textarea>
                    </div>
                    <div class="float-input-group">
                        <select class="float-input" id="m_type">
                            <option value="ad_copy">Ad Copy</option>
                            <option value="product_desc">Product Description</option>
                            <option value="caption">Social Caption</option>
                            <option value="email">Email Campaign</option>
                        </select>
                    </div>
                    <div class="float-input-group">
                        <input class="float-input" id="m_tone" placeholder="Tone (bold, witty, premium...)"
                            value="bold">
                    </div>
                    <button type="submit" class="glow-btn" style="width:100%;justify-content:center;padding:1rem;">
                        <i class="fas fa-pen-nib"></i> Generate Copy
                    </button>
                </form>
            </div>
            <div class="ai-loader" id="marketingLoader" style="display:none;">
                <div class="ai-loader-ring"></div>
                <div class="ai-loader-dots"><span></span><span></span><span></span></div>
                <div class="ai-loader-text">Writing brilliant copy...</div>
            </div>
            <div class="glass-card ai-result" id="marketingResult" style="display:none;max-width:700px;"></div>
        </div>

        <!-- ‚ïê‚ïê‚ïê VIEW: Startup Tools (Pitch + Email) ‚ïê‚ïê‚ïê -->
        <div class="page-view" id="view-pitch" style="display:none;">
            <div class="universe-header">
                <div>
                    <h1 class="page-title"><span class="grad">Startup</span> Tools</h1>
                    <p class="page-subtitle">Pitch decks, investor outreach, growth strategy</p>
                </div>
                <button class="ghost-btn" onclick="showView('home')"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div style="display:grid;gap:1.5rem;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));">
                <!-- Pitch -->
                <div class="glass-card" style="padding:2rem;">
                    <h3 style="margin-bottom:1rem;"><span class="grad">üöÄ</span> Elevator Pitch Generator</h3>
                    <form id="pitchForm">
                        <div class="float-input-group"><input class="float-input" id="p_name" placeholder="Product Name"
                                required></div>
                        <div class="float-input-group"><textarea class="float-input float-textarea" id="p_problem"
                                placeholder="The Problem" required></textarea></div>
                        <div class="float-input-group"><textarea class="float-input float-textarea" id="p_solution"
                                placeholder="The Solution" required></textarea></div>
                        <div class="float-input-group"><input class="float-input" id="p_audience"
                                placeholder="Target Audience" required></div>
                        <button type="submit" class="glow-btn" style="width:100%;justify-content:center;"><i
                                class="fas fa-bolt"></i> Generate Pitch</button>
                    </form>
                    <div class="ai-loader" id="pitchLoader" style="display:none;">
                        <div class="ai-loader-ring"></div>
                        <div class="ai-loader-dots"><span></span><span></span><span></span></div>
                        <div class="ai-loader-text">Pitching...</div>
                    </div>
                    <div class="glass-card ai-result" id="pitchResult" style="display:none;margin-top:1rem;"></div>
                </div>
                <!-- Investor Email -->
                <div class="glass-card" style="padding:2rem;">
                    <h3 style="margin-bottom:1rem;"><span class="grad">‚úâÔ∏è</span> Investor Email Writer</h3>
                    <form id="emailForm">
                        <div class="float-input-group"><input class="float-input" id="e_startup"
                                placeholder="Startup Name" required></div>
                        <div class="float-input-group"><input class="float-input" id="e_investor"
                                placeholder="Investor Name" required></div>
                        <div class="float-input-group"><input class="float-input" id="e_metrics"
                                placeholder="Key Metrics (e.g. $10k MRR, 500 users)" required></div>
                        <div class="float-input-group"><input class="float-input" id="e_ask"
                                placeholder="Your Ask (e.g. 15 min call, $500k seed)" required></div>
                        <button type="submit" class="glow-btn" style="width:100%;justify-content:center;"><i
                                class="fas fa-envelope"></i> Draft Email</button>
                    </form>
                    <div class="ai-loader" id="emailLoader" style="display:none;">
                        <div class="ai-loader-ring"></div>
                        <div class="ai-loader-dots"><span></span><span></span><span></span></div>
                        <div class="ai-loader-text">Drafting...</div>
                    </div>
                    <div class="glass-card ai-result" id="emailResult" style="display:none;margin-top:1rem;"></div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê VIEW: Sentiment ‚ïê‚ïê‚ïê -->
        <div class="page-view" id="view-sentiment" style="display:none;">
            <div class="universe-header">
                <div>
                    <h1 class="page-title"><span class="grad">Sentiment</span> Analyzer</h1>
                    <p class="page-subtitle">Analyze brand perception with NLP</p>
                </div>
                <button class="ghost-btn" onclick="showView('home')"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="glass-card" style="padding:2rem;max-width:700px;">
                <form id="sentimentForm">
                    <div class="float-input-group">
                        <textarea class="float-input float-textarea" id="s_text" rows="4"
                            placeholder="Paste a customer review or feedback..." required></textarea>
                    </div>
                    <div class="float-input-group">
                        <input class="float-input" id="s_tone" placeholder="Brand Tone (professional, playful...)"
                            value="professional">
                    </div>
                    <button type="submit" class="glow-btn" style="width:100%;justify-content:center;padding:1rem;">
                        <i class="fas fa-chart-line"></i> Analyze
                    </button>
                </form>
            </div>
            <div class="ai-loader" id="sentimentLoader" style="display:none;">
                <div class="ai-loader-ring"></div>
                <div class="ai-loader-dots"><span></span><span></span><span></span></div>
                <div class="ai-loader-text">Analyzing sentiment...</div>
            </div>
            <div id="sentimentResult" style="margin-top:1.5rem;max-width:700px;display:none;" class="glass-card"></div>
        </div>

        <!-- ‚ïê‚ïê‚ïê VIEW: AI Chat ‚ïê‚ïê‚ïê -->
        <div class="page-view" id="view-chat" style="display:none;">
            <div class="universe-header">
                <div>
                    <h1 class="page-title"><span class="grad">AI</span> Brand Consultant</h1>
                    <p class="page-subtitle">IBM Granite strategic advisor</p>
                </div>
                <button class="ghost-btn" onclick="showView('home')"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="glass-card" style="padding:0;max-width:700px;overflow:hidden;">
                <div id="chatMessages"
                    style="height:400px;overflow-y:auto;padding:1.5rem;display:flex;flex-direction:column;gap:1rem;">
                    <div
                        style="padding:.8rem 1.2rem;background:var(--surface);border-radius:var(--radius-sm);max-width:85%;color:var(--text-secondary);font-size:.9rem;">
                        üëã I'm your AI brand consultant. Ask me anything about branding, positioning, or growth
                        strategy.
                    </div>
                </div>
                <form id="chatForm" style="display:flex;border-top:1px solid var(--border);padding:.8rem;">
                    <input class="float-input" id="chatInput" placeholder="Ask about branding strategy..." required
                        style="border:none;background:transparent;border-radius:0;flex:1;">
                    <button type="submit" class="glow-btn" style="border-radius:var(--radius-sm);padding:.7rem 1.2rem;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê VIEW: Admin ‚ïê‚ïê‚ïê -->
        <div class="page-view" id="view-admin" style="display:none;">
            <div class="universe-header">
                <div>
                    <h1 class="page-title"><span class="grad">Admin</span> Dashboard</h1>
                    <p class="page-subtitle">Platform analytics & user management</p>
                </div>
                <button class="ghost-btn" onclick="showView('home')"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="stat-grid" id="adminStats"></div>
            <div class="glass-card" style="padding:1.5rem;overflow-x:auto;">
                <h3 style="margin-bottom:1rem;">User Management</h3>
                <table class="admin-table" id="adminTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- ‚ïê‚ïê‚ïê Upgrade Modal ‚ïê‚ïê‚ïê -->
    <div class="modal-overlay" id="upgradeModal">
        <div class="glass-card modal-content" style="text-align:center;">
            <h2 style="margin-bottom:.5rem;">Upgrade to <span class="grad">Pro</span></h2>
            <p style="color:var(--text-secondary);margin-bottom:2rem;">Unlock unlimited generations, HD logos, and
                investor tools.</p>
            <div class="pricing-amount" style="margin-bottom:1.5rem;">$19<span>/mo</span></div>
            <button class="glow-btn" style="width:100%;justify-content:center;padding:1rem;margin-bottom:1rem;"
                onclick="handleUpgrade()">
                <i class="fas fa-crown"></i> Go Pro Now
            </button>
            <button class="ghost-btn" style="width:100%;justify-content:center;" onclick="closeUpgradeModal()">
                Maybe Later
            </button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê Scripts ‚ïê‚ïê‚ïê -->
    <script src="js/universe.js"></script>
    <script>
        // const API_URL = ''; // Already declared in auth.js
        const TOKEN = localStorage.getItem('access_token');
        const HEADERS = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` };

        // ‚îÄ‚îÄ View Navigation (SPA-like) ‚îÄ‚îÄ
        function showView(name) {
            document.querySelectorAll('.page-view').forEach(v => {
                v.style.display = 'none';
            });
            const target = document.getElementById('view-' + name);
            if (target) {
                target.style.display = 'block';
                target.style.animation = 'none';
                target.offsetHeight; // trigger reflow
                target.style.animation = 'pageSlideIn 0.5s cubic-bezier(0.4,0,0.2,1) both';
            }
            // Update sidebar active
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar-link[data-view="${name}"]`);
            if (activeLink) activeLink.classList.add('active');
        }

        // Sidebar clicks
        document.querySelectorAll('.sidebar-link[data-view]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showView(link.dataset.view);
            });
        });

        // Module card clicks
        document.querySelectorAll('.module-card[data-view]').forEach(card => {
            card.addEventListener('click', () => showView(card.dataset.view));
        });

        // ‚îÄ‚îÄ Logout ‚îÄ‚îÄ
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            }, 500);
        });

        // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
        function showUpgradeModal() { document.getElementById('upgradeModal').classList.add('open'); }
        function closeUpgradeModal() { document.getElementById('upgradeModal').classList.remove('open'); }
        function handleUpgrade() {
            // In production: redirect to Stripe checkout
            alert('Redirecting to Stripe checkout...');
            closeUpgradeModal();
        }

        // ‚îÄ‚îÄ API Helper ‚îÄ‚îÄ
        async function apiCall(endpoint, body) {
            const res = await window.fetchWithRetry(`${API_URL}${endpoint}`, {
                method: 'POST', headers: HEADERS, body: JSON.stringify(body)
            }, 3);
            if (res.status === 403) {
                const data = await res.json();
                if (data.detail && data.detail.includes('Upgrade')) {
                    showUpgradeModal();
                    throw new Error(data.detail);
                }
                throw new Error(data.detail || 'Access denied');
            }
            if (!res.ok) { const d = await res.json(); throw new Error(d.detail || 'Request failed'); }
            return res.json();
        }

        function showLoader(id) { document.getElementById(id).style.display = 'flex'; }
        function hideLoader(id) { document.getElementById(id).style.display = 'none'; }

        // ‚îÄ‚îÄ Brand Names ‚îÄ‚îÄ
        document.getElementById('nameForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader('nameLoader');
            document.getElementById('nameResults').innerHTML = '';
            try {
                const data = await apiCall('/api/generate-brand', {
                    industry: document.getElementById('n_industry').value,
                    keywords: document.getElementById('n_keywords').value.split(',').map(k => k.trim()),
                    tone: document.getElementById('n_tone').value
                });
                hideLoader('nameLoader');
                const container = document.getElementById('nameResults');
                data.names.forEach((name, i) => {
                    const card = document.createElement('div');
                    card.className = 'glass-card';
                    card.style.cssText = `padding:1rem 1.5rem;animation:moduleEntrance 0.4s ease ${i * 0.05}s both;cursor:pointer;`;
                    card.innerHTML = `<span style="font-weight:700;font-size:1.05rem;">${name}</span>`;
                    card.addEventListener('click', () => {
                        navigator.clipboard.writeText(name);
                        card.innerHTML += `<span style="margin-left:.5rem;font-size:.75rem;color:var(--accent);">‚úì Copied</span>`;
                    });
                    container.appendChild(card);
                });
            } catch (err) { hideLoader('nameLoader'); alert(err.message); }
        });

        // ‚îÄ‚îÄ Logo ‚îÄ‚îÄ
        document.getElementById('logoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader('logoLoader');
            document.getElementById('logoResults').innerHTML = '';
            try {
                const data = await apiCall('/api/generate-logo', {
                    brand_name: document.getElementById('l_brand').value,
                    industry: document.getElementById('l_industry').value,
                    keywords: document.getElementById('l_keywords').value.split(',').map(k => k.trim()),
                    style: document.getElementById('l_style').value
                });
                hideLoader('logoLoader');
                const c = document.getElementById('logoResults');
                if (data.image_url) {
                    c.innerHTML = `
                        <div class="glass-card" style="padding:2rem;display:inline-block;">
                            <img src="${data.image_url}" alt="Logo" style="max-width:400px;border-radius:var(--radius-sm);margin-bottom:1rem;">
                            <br>
                            <a href="${data.image_url}" download class="glow-btn"><i class="fas fa-download"></i> Download HD</a>
                        </div>`;
                } else {
                    c.innerHTML = `<div class="glass-card" style="padding:1.5rem;color:var(--text-secondary);">Logo generation is processing. Try again in a moment.</div>`;
                }
            } catch (err) { hideLoader('logoLoader'); alert(err.message); }
        });

        // ‚îÄ‚îÄ Marketing ‚îÄ‚îÄ
        document.getElementById('marketingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader('marketingLoader');
            document.getElementById('marketingResult').style.display = 'none';
            try {
                const data = await apiCall('/api/generate-content', {
                    brand_name: document.getElementById('m_brand').value,
                    description: document.getElementById('m_desc').value,
                    content_type: document.getElementById('m_type').value,
                    tone: document.getElementById('m_tone').value
                });
                hideLoader('marketingLoader');
                const r = document.getElementById('marketingResult');
                r.style.display = 'block';
                typewriterReveal(r, data.content, 12);
            } catch (err) { hideLoader('marketingLoader'); alert(err.message); }
        });

        // ‚îÄ‚îÄ Pitch ‚îÄ‚îÄ
        document.getElementById('pitchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader('pitchLoader');
            document.getElementById('pitchResult').style.display = 'none';
            try {
                const data = await apiCall('/api/generate-pitch', {
                    product_name: document.getElementById('p_name').value,
                    problem: document.getElementById('p_problem').value,
                    solution: document.getElementById('p_solution').value,
                    audience: document.getElementById('p_audience').value
                });
                hideLoader('pitchLoader');
                const r = document.getElementById('pitchResult');
                r.style.display = 'block';
                typewriterReveal(r, data.pitch, 12);
            } catch (err) { hideLoader('pitchLoader'); alert(err.message); }
        });

        // ‚îÄ‚îÄ Investor Email ‚îÄ‚îÄ
        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader('emailLoader');
            document.getElementById('emailResult').style.display = 'none';
            try {
                const data = await apiCall('/api/generate-investor-email', {
                    startup_name: document.getElementById('e_startup').value,
                    investor_name: document.getElementById('e_investor').value,
                    key_metrics: document.getElementById('e_metrics').value,
                    ask: document.getElementById('e_ask').value
                });
                hideLoader('emailLoader');
                const r = document.getElementById('emailResult');
                r.style.display = 'block';
                typewriterReveal(r, data.email, 12);
            } catch (err) { hideLoader('emailLoader'); alert(err.message); }
        });

        // ‚îÄ‚îÄ Sentiment ‚îÄ‚îÄ
        document.getElementById('sentimentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader('sentimentLoader');
            document.getElementById('sentimentResult').style.display = 'none';
            try {
                const data = await apiCall('/api/analyze-sentiment', {
                    text: document.getElementById('s_text').value,
                    brand_tone: document.getElementById('s_tone').value
                });
                hideLoader('sentimentLoader');
                const r = document.getElementById('sentimentResult');
                r.style.display = 'block';
                r.style.padding = '2rem';
                const color = data.sentiment === 'Positive' ? '#10b981' : data.sentiment === 'Negative' ? '#ef4444' : '#f59e0b';
                r.innerHTML = `
                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                        <div style="width:60px;height:60px;border-radius:50%;border:3px solid ${color};display:flex;align-items:center;justify-content:center;font-size:1.5rem;">${data.sentiment === 'Positive' ? 'üòä' : data.sentiment === 'Negative' ? 'üòû' : 'üòê'}</div>
                        <div>
                            <div style="font-weight:800;font-size:1.3rem;color:${color};">${data.sentiment}</div>
                            <div style="color:var(--text-secondary);font-size:.85rem;">Confidence: ${(data.confidence * 100).toFixed(0)}%</div>
                        </div>
                    </div>
                    <p style="color:var(--text-secondary);font-size:.9rem;line-height:1.7;">${data.tone_alignment}</p>`;
            } catch (err) { hideLoader('sentimentLoader'); alert(err.message); }
        });

        // ‚îÄ‚îÄ AI Chat ‚îÄ‚îÄ
        const chatBox = document.getElementById('chatMessages');
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            // User bubble
            chatBox.innerHTML += `<div style="align-self:flex-end;padding:.8rem 1.2rem;background:var(--gradient-accent);border-radius:var(--radius-sm) var(--radius-sm) 4px var(--radius-sm);max-width:85%;color:#fff;font-size:.9rem;">${msg}</div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
            // Thinking indicator
            const thinkId = 'think-' + Date.now();
            chatBox.innerHTML += `<div id="${thinkId}" style="padding:.8rem 1.2rem;background:var(--surface);border-radius:var(--radius-sm);max-width:85%;display:flex;gap:4px;"><span class="ai-loader-dots" style="display:flex;gap:4px;"><span></span><span></span><span></span></span></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const data = await apiCall('/api/chat', { message: msg });
                document.getElementById(thinkId).remove();
                const reply = document.createElement('div');
                reply.style.cssText = 'padding:.8rem 1.2rem;background:var(--surface);border-radius:var(--radius-sm);max-width:85%;font-size:.9rem;color:var(--text-secondary);';
                chatBox.appendChild(reply);
                typewriterReveal(reply, data.response, 15);
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (err) {
                document.getElementById(thinkId).remove();
                chatBox.innerHTML += `<div style="padding:.8rem 1.2rem;background:rgba(239,68,68,.1);border-radius:var(--radius-sm);color:#ef4444;font-size:.85rem;">Error: ${err.message}</div>`;
            }
        });

        // ‚îÄ‚îÄ Admin ‚îÄ‚îÄ
        async function loadAdmin() {
            try {
                const stats = await window.fetchWithRetry(`${API_URL}/api/admin/stats`, { headers: HEADERS }, 3).then(r => r.json());
                document.getElementById('adminStats').innerHTML = `
                    <div class="glass-card stat-card"><h4>Total Users</h4><div class="stat-value">${stats.total_users}</div></div>
                    <div class="glass-card stat-card"><h4>Active Users</h4><div class="stat-value">${stats.active_users}</div></div>
                    <div class="glass-card stat-card"><h4>Pro Users</h4><div class="stat-value">${stats.pro_users}</div></div>
                    <div class="glass-card stat-card"><h4>Generations</h4><div class="stat-value">${stats.total_generations}</div></div>
                    <div class="glass-card stat-card"><h4>MRR</h4><div class="stat-value" data-prefix="$">${stats.mrr || 0}</div><div class="stat-trend up"><i class="fas fa-dollar-sign"></i> Monthly Revenue</div></div>
                    <div class="glass-card stat-card"><h4>Conversion</h4><div class="stat-value">${stats.conversion_rate || 0}%</div><div class="stat-trend"><i class="fas fa-chart-line"></i> Pro / Total</div></div>
                `;
                const users = await window.fetchWithRetry(`${API_URL}/api/admin/users`, { headers: HEADERS }, 3).then(r => r.json());
                document.getElementById('adminTableBody').innerHTML = users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.email}</td>
                        <td>${u.fullname || '‚Äî'}</td>
                        <td><span style="color:${u.role === 'admin' ? 'var(--accent)' : 'var(--text-secondary)'}">${u.role}</span></td>
                        <td><span style="color:${u.is_active ? '#10b981' : '#ef4444'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td><button class="admin-btn" onclick="toggleRole(${u.id},'${u.role}')">${u.role === 'admin' ? 'Demote' : 'Promote'}</button></td>
                    </tr>
                `).join('');
            } catch (err) { /* not admin */ }
        }

        async function toggleRole(id, currentRole) {
            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            await window.fetchWithRetry(`${API_URL}/api/admin/users/${id}/role`, {
                method: 'PUT', headers: HEADERS,
                body: JSON.stringify({ role: newRole })
            }, 3);
            loadAdmin();
        }

        // ‚îÄ‚îÄ Init Data Load ‚îÄ‚îÄ
        async function loadDashboardData() {
            // Check if admin
            try {
                const res = await window.fetchWithRetry(`${API_URL}/api/admin/stats`, { headers: HEADERS }, 3);
                if (res.ok) document.getElementById('adminLink').style.display = '';
            } catch (e) { }

            loadAdmin();

            // Fetch current user details to update Plan UI
            try {
                const me = await window.fetchWithRetry(`${API_URL}/api/auth/me`, { headers: HEADERS }, 3).then(r => r.json());
                if (me.subscription_plan && ['pro', 'enterprise', 'admin'].includes(me.subscription_plan)) {
                    // Update Plan Text
                    document.getElementById('statPlan').innerText = me.subscription_plan.charAt(0).toUpperCase() + me.subscription_plan.slice(1);
                    // Hide Upgrade Link
                    const upgradeLink = document.querySelector('#statPlan + .stat-trend a');
                    if (upgradeLink) upgradeLink.parentElement.style.display = 'none';
                }
            } catch (e) { console.error("Failed to fetch user profile", e); }

            // Re-init card effects
            setTimeout(() => {
                initCardEffects();
                initRippleButtons();
                initMagneticLinks();
            }, 100);
        }
    </script>
    <div id="authLoader" class="auth-skeleton">
        <div class="skeleton-sidebar">
            <div class="skeleton-item" style="height: 32px; width: 60%; margin-bottom: 2rem;"></div>
            <div class="skeleton-item"></div>
            <div class="skeleton-item"></div>
            <div class="skeleton-item"></div>
            <div class="skeleton-item"></div>
            <div class="skeleton-item" style="margin-top: auto;"></div>
        </div>
        <div class="skeleton-main">
            <div class="skeleton-header"></div>
            <div class="skeleton-cards">
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
            </div>
            <div
                style="flex:1; background: rgba(255,255,255,0.02); border-radius: 12px; margin-top: 2rem; animation: pulse 1.5s infinite">
            </div>
        </div>
    </div>
    <script>
        async function initDashboard() {
            try {
                if (!window.supabaseClient) {
                    throw new Error("Supabase client not initialized");
                }

                // Validate Supabase session using getSession()
                const { data, error } = await window.supabaseClient.auth.getSession();
                if (error || !data || !data.session || !data.session.access_token) {
                    throw new Error("No active Supabase session found");
                }

                const token = data.session.access_token;

                // Route Guard: Explicitly wait for backend session validation
                const sessionRes = await window.fetchWithRetry(`${API_URL}/api/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }, 3);
                if (!sessionRes.ok) throw new Error("Invalid session token against FastAPI backend");

                // Session is verified, load data into UI elements
                await loadDashboardData();

                // Validation passed, initiate Motion Render Layer
                const loader = document.getElementById('authLoader');
                loader.style.opacity = '0';

                document.getElementById('sidebar').classList.add('sidebar-animate');
                document.getElementById('mainContent').classList.add('main-animate');

                const statCards = document.querySelectorAll('.stat-card');
                statCards.forEach((card, i) => {
                    card.classList.add('kpi-animate');
                    card.style.animationDelay = `${i * 0.1}s`;
                });

                setTimeout(() => loader.remove(), 500);
            } catch (e) {
                console.warn("Dashboard Route Guard failed:", e);
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            }
        }

        // We run initDashboard mapping natively to hook the load process
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>

</html>